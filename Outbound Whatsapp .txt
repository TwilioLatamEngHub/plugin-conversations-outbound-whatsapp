
title Outbound Whatsapp


participant Flex
participant Functions

participant Flex Iteractions API
participant Conversations API

==Outbound Whatsapp Message creating task to the agent ==
note over Flex: SendWhatsappOutbound Action
Flex->Functions:
Functions->Conversations API: Fetch ParticipantConversations by binding address
alt case address has an active conversations
alt case Conversation has a webhook attribute
Functions->Conversations API: Removes conversations Webhook 
Functions->Flex Iteractions API: Creates a new InteractionChannel Invite 
else case Conversation don't have a webhook attribute
Functions->Conversations API: Closes Conversation
Functions->Flex Iteractions API: Creates a new Interaction with participant.address
end
else case address do not has an active conversations
Functions->Flex Iteractions API: Creates a new Interaction with participant.address
end
Functions->Conversations API: Add Outbound message to conversation
Flex<-Flex: TaskRouter creates a new Task\n and route to same agent to Flex using routing \nproperties of the InteractionChannel

==Outbound Whatsapp Message creating task on customer reply ==

note over Flex: SendWhatsappOutbound Action
Flex->Functions:
Functions->Conversations API: Fetch ParticipantConversations by binding address
alt  case address do not has an active conversations
Functions->Conversations API: Creates new Conversation
Functions->Conversations API: Adds Conversation Participant with messagingBinding.address and proxyAddress
end
Functions->Conversations API: Adds Webhook to Studio Flow
Functions->Conversations API: Add Outbound message to conversation
note over Conversations API: On Customer Reply, it will interact with Studio Flow.\nIf not required, the Flow can immediately Send To Flex.
